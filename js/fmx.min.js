function refreshFilst(){window.location=window.location.href.split("#")[0]}function postAndRefresh(b){$.post(fmx_AJ,b,function(a,b,f){a?alert(a):refreshFilst()})}
var aMsgDlg={cselect:"#aMsgDlog",buttons:{"Okay`prm":function(){myCloseDlg(this)}}},aSchDlg={cselect:"#aSchDlog",buttons:{"Search`prm":function(){var b=document.myUIform;if(b.sterm.value.trim()){var a=b.sterm.value.trim(),d=document.forms.cliterm;"srhf"===b.cmd.value?(sessionStorage.fmx_strmf=a,d.cmdlin.value="find ./ -name "+a+" -ls"):(sessionStorage.fmx_strmc=a,d.cmdlin.value="grep -R -I "+a+" *");d.submit();myCloseDlg(this)}else alert("Please enter a valid search term")}}},fRenDlg={cselect:"#fRenDlog",
modal:!0,buttons:{"Rename`prm":function(){var b=document.myUIform;b.nunam.value.trim()?(b={act:"fren",fref:curDir+b.oldnm.value,nunm:curDir+b.nunam.value.trim()},myCloseDlg(this),postAndRefresh(b)):alert("Please enter a valid name")}}},fNamDlg={cselect:"#fNamDlog",buttons:{"Create`prm":function(){var b=document.myUIform;b.fref.value.trim()?(b={act:b.act.value,fref:curDir+b.fref.value.trim()},myCloseDlg(this),postAndRefresh(b)):alert("Please enter a valid name")}}},fCpmDlg={cselect:"#fCpmDlog",buttons:{"{CM}":function(){var b=
document.myUIform;b.cpm2nam.value.trim()?(b={act:b.act.value,fref:b.cpmfnm.value,tonm:b.cpm2nam.value.trim()},myCloseDlg(this),postAndRefresh(b)):alert("Please enter a valid path")}}},upldAction={H5w:function(){popUp(fmx_appPath+"filupld5d.php")},H5o:function(b){$("#upload").jqm({ajax:fmx_appPath+"filupld5dm.php",ajaxText:"Loading...",onLoad:b,onHide:function(a){refreshFilst()},target:".upldr",overlay:5}).jqmShow()},L4w:function(){popUp(fmx_appPath+"filupld.php")},L4o:function(){$("#upload").jqm({ajax:fmx_appPath+
"filupldm.php",ajaxText:"Loading...",onHide:function(b){refreshFilst()},target:".upldr",overlay:5}).jqmShow()},Chk:function(){popUp(fmx_appPath+"upchunk.php")}};function downloadFile(b,a,d){b=fmx_appPath+"fildnld.php?fle="+escape(b)+(a?"&tcdl=1&rad=Y":"")+(d?"&asf="+d:"");a=document.createElement("iframe");a.src=b;a.style.display="none";document.body.appendChild(a)}
function makeFileList(b,a){var d=a?"<br />":" ",f="",e,c=b.split("\x00"),g,k,h,l;for(e in c)for(h in g=c[e].split("&"),k="",g)l=g[h].split("="),0===1*h?k=l[1]:f+=k+"%2F"+l[1]+d;return f.replace(/%2F/g,"/")}function doesSupportAjaxUploadWithProgress(){var b;if(b="undefined"!==typeof window.FileList)b=new XMLHttpRequest,b=!!(b&&"upload"in b&&"onprogress"in b.upload);return b}
function pop(b,a,d){return window.open(b,"","toolbar=no,status=no,location=no,menubar=no,resizable=0,scrollbars=1,width="+d+",height="+a+",left="+(screen.width-d)/2+",top="+(screen.height-a)/2)}
function popPost(b,a,d,f,e){var c="",g;for(g in a)c+='<input type="hidden" name="'+g+'" value="'+a[g]+'" />';b=$('<form action="'+b+'" method="post" target="'+d+'">'+c+"</form>");window.open("",d,"toolbar=no,status=no,location=no,menubar=no,resizable=0,scrollbars=1,width="+e+",height="+f+",left="+(screen.width-e)/2+",top="+(screen.height-f)/2).focus();b[0].submit()}function popUp(b){pop(b,240,416)}
function doMenuAction(b,a){var d=$(".fsel:checked"),f=d.length,e,c,g;c=function(){if(f)if(1<f)alert("Please select only one item.");else return!0;else alert("An item needs to be selected");return!1};g=function(){if(f)return!0;alert("Some items need to be selected");return!1};switch(b){case "copy":c()&&(c=curDir+$(d[0]).parents("tr").attr("data-fref"),myOpenDlg(a,$.extend({},fCpmDlg,{bover:{"{CM}":"Copy`prm"}}),{act:b,cpm:c},"Copy:"));break;case "cppa":f?sessionStorage.fmx_cppa=$("form[name='filst']").serialize():
sessionStorage.fmx_cppa&&postAndRefresh("act=cppa&todr="+encodeURIComponent(curDir)+"&"+sessionStorage.fmx_cppa);break;case "delf":g()&&(1==f||confirm("You have multiple files selected. Are you sure you want to delete ALL the selected files?"))&&postAndRefresh("act=delf&"+$("form[name='filst']").serialize());break;case "dnld":g()&&(e="act=dnld&"+$("form[name='filst']").serialize(),$("div.dnldprg").css("display","inline"),$.post(fmx_AJ,e,function(a,b,c){$("div.dnldprg").css("display","none");a?downloadFile(a.fpth,
"Y"==a.rad,!1):alert("download not available")},"json"));break;case "dupl":c()&&(e={act:"dupl",fref:curDir+$(d[0]).parents("tr").attr("data-fref")},postAndRefresh(e));break;case "mark":e=void 0===sessionStorage.fmx_mrkd?"":sessionStorage.fmx_mrkd+"\x00";f&&(sessionStorage.fmx_mrkd=e+$("form[name='filst']").serialize());break;case "mmiz":g()&&postAndRefresh("act=mmiz&"+$("form[name='filst']").serialize());break;case "move":c()&&(c=curDir+$(d[0]).parents("tr").attr("data-fref"),myOpenDlg(a,$.extend({},
fCpmDlg,{bover:{"{CM}":"Move`prm"}}),{act:b,cpm:c},"Move:"));break;case "mvto":if(f)sessionStorage.fmx_mvto=$("form[name='filst']").serialize();else{if(!sessionStorage.fmx_mvto){alert("Nothing previously selected to move");break}postAndRefresh("act=mvto&todr="+encodeURIComponent(curDir)+"&"+sessionStorage.fmx_mvto)}break;case "nfle":case "nfld":myOpenDlg(a,fNamDlg,{act:b},"nfle"==b?"New File":"New Folder");break;case "refr":refreshFilst();break;case "rnam":c()&&(c=$(d[0]).parents("tr").attr("data-fref"),
myOpenDlg(a,fRenDlg,{old:c,"new":c}));break;case "srhf":case "srhc":c=sessionStorage.fmx_strmf;"srhc"==b&&(c=sessionStorage.fmx_strmc);myOpenDlg(a,aSchDlg,{cmd:b,trm:c});break;case "turl":c()&&$("#upload").jqm({ajax:fmx_appPath+"filcurlm.php?t=1",ajaxText:"Loading...",target:".upldr",overlay:5}).jqmShow();break;case "furl":$("#upload").jqm({ajax:fmx_appPath+"filcurlm.php",ajaxText:"Loading...",target:".upldr",overlay:5}).jqmShow();break;case "upld":doesSupportAjaxUploadWithProgress()?upload_winpop?
upldAction.H5w():upldAction.H5o():upload_winpop?upldAction.L4w():upldAction.L4o();break;case "uzip":case "zip":case "tarz":case "utrz":if(c()){c=$(d[0]).parents("tr").attr("data-fref");g=document.forms.cliterm;if("zip"==b){var k="zip ";$(d[0]).parent().next().hasClass("foldCtxt")&&(k+="-r ");d=c.replace(/\s/g,"_");g.cmdlin.value=k+d+'.zip "'+c+'"'}else"uzip"==b?g.cmdlin.value='unzip "'+c+'"':"tarz"==b?(d=c.replace(/\s/g,"_"),g.cmdlin.value="tar -czf "+d+'.tgz "'+c+'"'):"utrz"==b&&(g.cmdlin.value=
'tar -xzf "'+c+'"');g.submit()}break;case "webv":if(c()){c=$(d[0]).parents("tr").attr("data-fref");if(a.shiftKey&&(c=prompt("URL:",c),!c))break;d=curDir.slice(curDir.search("/"));pop(d+c,screen.availHeight,1200)}break;case "jxtr":c()&&(c=curDir+$(d[0]).parents("tr").attr("data-fref"),(d=c.match(/([^\/\\]+)\.(\w+)$/))&&"xml"==d[2]?(e={act:"jxtr",fref:c,dir:curDir},$.post(fmx_AJ,e,function(a,b,c){a&&alert(a)})):alert("Must be an XML file"));break;case "sql3":if(!f||c())e="?dir="+curDir,f&&(e="?dbf="+
curDir+$(d[0]).parents("tr").attr("data-fref")),pop(fmx_appPath+"pla/phpliteadmin.php"+e,screen.availHeight,.8*screen.availWidth);break;case "fmxi":e={act:"fmxi"};$.post(fmx_AJ,e,function(b,c,d){if(b){if(b.updt){var f=b.updt.split("|");c=$.extend(!0,{},aMsgDlg,{buttons:{"Update now":function(){confirm("It is a good idea to backup first. Do you want to continue with the update?")&&(e={act:"updt",nver:f[1]},$.post(fmx_AJ,e,function(a,b,c){a?alert(a):refreshFilst()}),myCloseDlg(this))}}})}else c=aMsgDlg;
myOpenDlg(a,c,{msg:b.msg},"FMX - Hosted File Manager")}},"json");break;case "cmcs":var h=document.createElement("div");h.id="util-view";c=document.createElement("div");c.innerHTML="Loading ...";h.style.left=a.clientX-60+"px";h.style.top=a.clientY-48+"px";h.appendChild(c);document.body.appendChild(h);e={act:"CLIC"};$(h).load(fmx_AJ,e,function(b,c,d){h.style.top=a.clientY-h.clientHeight-20+"px";$("#util-view div").click(function(a){a.preventDefault();doFillCLI($(this).attr("data-cmd"));document.body.removeChild(h)})});
break;case "mnu":break;default:alert("?"+b+"?")}}var editWindow;function doViewFile(b){pop(fmx_appPath+"filwin.php?fref="+b,600,800)}function doEditFile(b){editWindow=pop(fmx_appPath+"filedtwin.php?fref="+b,screen.availHeight,screen.availWidth)}function doEditImage(b){popPost(fmx_appPath+"imgedtwin.php",{fref:b},"imgedt",screen.availHeight,Math.min(1200,screen.availWidth))}
function doFileAction(b,a,d){d&&(d.preventDefault(),d.stopPropagation());var f=escape($(a).parents("tr").attr("data-fref"));a=curDir+f;switch(b){case "finf":b={act:b,fref:a};$.post(fmx_AJ,b,function(a,b,g){a&&myOpenDlg(d,aMsgDlg,{msg:a},"File info for: "+f)});break;case "fvue":doViewFile(a);break;case "fedt":doEditFile(a);break;case "iedt":doEditImage(a);break;default:alert("?"+b+"?")}}function doFillCLI(b){$("#cmdlin").val(b)}
function allSelect(b,a){a.checked?$(".fsel").prop("checked",!0):$(".fsel").prop("checked",!1)}function fils2up(){if(""===document.cliterm.cmdlin.value)return alert("Please enter a command."),!1;var b=document.cliterm.cmdlin.value;0<b.indexOf("$$")&&(document.cliterm.cmdlin.value=b.replace("$$",makeFileList(sessionStorage.fmx_mrkd,!1)));document.cliterm.submit();return!0}
function selectionAction(b){var a="";"undefined"!==window.getSelection?a=window.getSelection():"undefined"!==document.selection&&"Text"==document.selection.type&&(a=document.selection.createRange().text);a=curDir+a;b?doEditFile(a):doViewFile(a)}function display_cmmStorage(b){if(b){var a="";b=b.split("\x00");for(var d in b)for(var f=decodeURIComponent(b[d]).split("&"),e=0;e<f.length;e++)0<e&&(a+="    "),a+=f[e]+"\n";alert(a)}else alert("[ empty ]")}
function fileDragin(b){b.stopPropagation();b.preventDefault();b.target.className="dragover"==b.type?"hover":""}
$(function(){try{sessionStorage.fmx_ok=1}catch(b){alert("Your browser 'sessionStorage' is not functioning. (private browsing?) Not all functions of FMX will work successfully.")}sessionStorage.fmx_curD=curDir;$("#fmnu [data-mnu]").click(function(a){a.preventDefault();doMenuAction($(this).attr("data-mnu"),a)});$("#trmfrm [data-mnu]").click(function(a){a.preventDefault();doMenuAction($(this).attr("data-mnu"),a)});$("#ftbl [data-act]").click(function(a){a.preventDefault();doFileAction($(this).attr("data-act"),
this,a)});$("nav li ul").hide().removeClass("fallback");$("nav li").hover(function(){$("ul",this).stop(!0,!0).fadeToggle(100)});$("a.cppaMenu").contextMenu("cppaMenu",{bindings:{cppaClr:function(a){sessionStorage.removeItem("fmx_cppa")},cppaDsp:function(a){display_cmmStorage(sessionStorage.fmx_cppa)}}});$("a.markMenu").contextMenu("cppaMenu",{bindings:{cppaClr:function(a){sessionStorage.removeItem("fmx_mrkd")},cppaDsp:function(a){display_cmmStorage(sessionStorage.fmx_mrkd)}}});$("a.mvtoMenu").contextMenu("cppaMenu",
{bindings:{cppaClr:function(a){sessionStorage.removeItem("fmx_mvto")},cppaDsp:function(a){display_cmmStorage(sessionStorage.fmx_mvto)}}});$("a.upldMenu").contextMenu("upldMenu",{onContextMenu:function(a){return!0},bindings:{H5w:function(a){upldAction.H5w()},H5o:function(a){upldAction.H5o()},L4w:function(a){upldAction.L4w()},L4o:function(a){upldAction.L4o()},Chk:function(a){upldAction.Chk()}}});$("td.fileCtxt").contextMenu("fileCtxt",{bindings:{cfi_edt:function(a){doFileAction("fedt",a,null)},cfi_del:function(a){a=
$(a).parents("tr").attr("data-fref");confirm("Are you sure you want to delete this file: "+a+" ?")&&postAndRefresh("act=delf&dir="+encodeURIComponent(curDir)+"&files[]="+a)},cfi_dld:function(a){alert("Download")},cfi_ren:function(a){a=$(a).parents("tr").attr("data-fref");myOpenDlg(null,fRenDlg,{old:a,"new":a})}}});$("td.foldCtxt").contextMenu("foldCtxt",{bindings:{cfo_del:function(a){alert("del")},cfo_dld:function(a){alert("dld")},cfo_dup:function(a){alert("dup")},cfo_ren:function(a){alert("ren")},
cfo_zip:function(a){alert("zip")}}});$("#filsform").on("dragover",fileDragin);$("#filsform").on("dragleave",fileDragin);$("#filsform").on("drop",function(a){var b=a.originalEvent.dataTransfer.files;fileDragin(a);upldAction.H5o(function(){fupQadd2(b)})})});