"use strict";function refreshFilst(){window.location=window.location.href.split("#")[0]}function refreshFilstO(e){let t=window.location.href.split("#")[0].split("?");t[1]?window.location=t[0]+"?"+t[1].split("&")[0]+"&O="+e:window.location=t[0]+"?O="+e}const form2string=e=>{let t=new FormData(document.forms[e]);return new URLSearchParams(t).toString()},toFormData=e=>{const t=new FormData;return Object.keys(e).forEach(a=>{"object"!=typeof e[a]?t.append(a,e[a]):t.append(a,JSON.stringify(e[a]))}),t};function postAction(e,t={},a=()=>{},n=!1){"object"==typeof t?t instanceof FormData||(t=toFormData(t)):"string"==typeof t&&(t=new URLSearchParams(t)),e&&t.set("act",e),fetch(fmx_AJ,{method:"POST",body:t}).then(e=>{if(!e.ok)throw new Error("Network response was not OK");return n?e.json():e.text()}).then(e=>a(e)).catch(e=>alert(e))}function postAndRefresh(e,t=()=>{}){postAction(null,e,e=>{t(),e?alert(e):refreshFilst()})}function postFormAndRefresh(e){let t=new FormData(document.forms.filst);t.set("act",e),postAndRefresh(t)}var editWindow,aMsgDlg={title:"Message:",cselect:"#aMsgDlog",hasX:!0},aSchDlg={cselect:"#aSchDlog",hasX:!0,buttons:{search:{text:"Search"}}},fRenDlg={id:4,title:"Rename...",cselect:"#fRenDlog",modal:!0,hasX:!0,buttons:{rename:{text:"Rename"}}},fNamDlg={cselect:"#fNamDlog",hasX:!0,buttons:{create:{text:"Create"}}},upldAction={H5w:()=>popUp(fmx_appPath+"filupld5.php"),H5o:e=>RJ_DlogMgr.fetchDlog(fmx_appPath+"filupld5.php?o=1",{title:"Upload files ...",ready:()=>{H5uSetup(),e&&e()}}),L4w:()=>popUp(fmx_appPath+"filupld.php"),L4o:()=>RJ_DlogMgr.fetchDlog(fmx_appPath+"filupld.php?o=1",{title:"Upload files ..."})};function downloadFile(e,t,a){let n=fmx_appPath+"fildnld.php?fle="+encodeURI(e)+(t?"&tcdl=1&rad=Y":"")+(a?"&asf="+a:""),o=document.createElement("iframe");o.src=n,o.style.display="none",document.body.appendChild(o)}function makeFileList(e,t){let a,n,o,r,i,l=t?"<br />":" ",s="",c=e.split("\0"),d=encodeURIComponent(curDir).length;for(a in c)for(r in n=c[a].split("&"),o="",n)i=n[r].split("="),1*r==0?o=i[1].substr(d):s+=o+"%2F"+i[1]+l;return s.replace(/%2F/g,"/")}function doesSupportAjaxUploadWithProgress(){return void 0!==window.FileList&&function(){let e=new XMLHttpRequest;return!!(e&&"upload"in e&&"onprogress"in e.upload)}()}function pop(e,t,a){a>screen.availWidth&&(a=screen.availWidth);let n=(screen.height-t)/2,o="toolbar=no,status=no,location=no,menubar=no,resizable=0,scrollbars=1,width="+a+",height="+t+",left="+(screen.width-a)/2+",top="+n;return window.open(e,"",o)}function popPost(e,t,a,n,o){o>screen.availWidth&&(o=screen.availWidth);let r,i="";for(r in t)i+='<input type="hidden" name="'+r+'" value="'+t[r]+'" />';let l=rjHtmlElement("form",{action:e,method:"post",target:a},i);document.body.appendChild(l);let s=(screen.height-n)/2,c="toolbar=no,status=no,location=no,menubar=no,resizable=0,scrollbars=1,width="+o+",height="+n+",left="+(screen.width-o)/2+",top="+s;window.open("",a,c).focus(),l.submit()}function popUp(e){pop(e,240,416)}function doMenuAction(e,t){var a,n,o,r,i=document.querySelectorAll(".fsel:checked"),l=i[0]?.parentElement.parentElement.dataset.fref,s=i.length,c=()=>{if(s){if(!(s>1))return!0;alert("Please select only one item.")}else alert("An item needs to be selected");return!1},d=()=>!!s||(alert("Some items need to be selected"),!1);switch(e){case"cppa":s?(sessionStorage.fmx_cppa=form2string("filst"),show_mcount("cppaMenu",sessionStorage.fmx_cppa)):sessionStorage.fmx_cppa&&postAndRefresh("act=cppa&todr="+encodeURIComponent(curDir)+"&"+sessionStorage.fmx_cppa);break;case"trsh":d()&&(1==s||confirm("You have multiple files selected. Are you sure you want to trash ALL the selected files?"))&&postFormAndRefresh("trsh");break;case"mpty":postAndRefresh("act=mpty");break;case"delf":d()&&(1==s||confirm("You have multiple files selected. Are you sure you want to delete ALL the selected files?"))&&postFormAndRefresh("delf");break;case"tvew":window.location="?dir=tmp/Trash";break;case"dnld":if(d()){let e=document.querySelector("div.dnldprg");e.style.display="inline",(a=new FormData(document.forms.filst)).set("act","dnld"),postAction(null,a,t=>{e.style.display="none",t?downloadFile(t.fpth,"Y"==t.rad,!1):alert("download not available")},!0)}break;case"dupl":c()&&postAndRefresh(a={act:"dupl",fref:curDir+l});break;case"mark":a=void 0===sessionStorage.fmx_mrkd?"":sessionStorage.fmx_mrkd+"\0",s&&(sessionStorage.fmx_mrkd=a+form2string("filst"),bump_mcount("markMenu",s));break;case"mmiz":if(c()){let e=l;RJ_DlogMgr.fetchDlog("jsmini.php?f="+encodeURIComponent(e),{title:"Minimize javascript file..."})}break;case"mvto":if(s)sessionStorage.fmx_mvto=form2string("filst"),show_mcount("mvtoMenu",sessionStorage.fmx_mvto);else{if(!sessionStorage.fmx_mvto){alert("Nothing previously selected to move");break}a=sessionStorage.fmx_mvto,sessionStorage.removeItem("fmx_mvto"),postAndRefresh("act=mvto&todr="+encodeURIComponent(curDir)+"&"+a)}break;case"nfle":case"nfld":fNamDlg.title="nfle"==e?"New File":"New Folder",rjOpenDlg(t,fNamDlg,{fattrs:{'input[name="act"]|value':e},cb:(e,t)=>{if("create"!=e)return;let a=t.get("fref").trim();if(!a)return alert("Please enter a valid name"),!1;postAndRefresh({act:t.get("act"),fref:curDir+a})}});break;case"refr":refreshFilst();break;case"rnam":c()&&doRenameFile(n=l,t);break;case"srhf":case"srhc":let p=sessionStorage.fmx_strmf;"srhc"==e?(p=sessionStorage.fmx_strmc,aSchDlg.title="Search files for content..."):aSchDlg.title="Search for file named like...",rjOpenDlg(t,aSchDlg,{fattrs:{'input[name="cmd"]|value':e,'input[name="sterm"]|value':p},cb:(e,t)=>{if("search"!=e)return;let a=t.get("sterm").trim();if(!a)return alert("Please enter a valid search term"),!1;let n=t.get("cmd"),o=document.forms.cliterm;"srhf"===n?(sessionStorage.fmx_strmf=a,o.cmdlin.value="find ./ -name "+a+" -ls"):(sessionStorage.fmx_strmc=a,o.cmdlin.value="grep -R -I "+a+" *"),o.submit()}});break;case"turl":c()&&RJ_DlogMgr.fetchDlog(fmx_appPath+"filcurlm.php?t=1",{title:"Send file to URL ..."});break;case"furl":RJ_DlogMgr.fetchDlog(fmx_appPath+"filcurlm.php",{title:"Get file from URL ..."});break;case"mdya":pop(fmx_appPath+"media.php?sd=/"+sessionStorage.fmx_curD,screen.availHeight,1200);break;case"upld":doesSupportAjaxUploadWithProgress()?upload_winpop?upldAction.H5w():upldAction.H5o():upload_winpop?upldAction.L4w():upldAction.L4o();break;case"uzip":case"zip":case"tarz":case"utrz":if(c()){if(n=l,o=document.forms.cliterm,"zip"==e){let e="zip ";if("fldCtx"==i[0].parentElement.nextElementSibling.dataset.ctx&&(e+="-r "),r=n.replace(/\s/g,"_"),o.cmdlin.value=e+r+'.zip "'+n+'"',t.shiftKey){let e=prompt("COMMAND:",o.cmdlin.value+' -x "*/sv_*" -x "*/.git*"');if(!e)break;o.cmdlin.value=e}}else"uzip"==e?o.cmdlin.value='unzip "'+n+'"':"tarz"==e?(r=n.replace(/\s/g,"_"),o.cmdlin.value="tar -czf "+r+'.tgz "'+n+'"'):"utrz"==e&&(o.cmdlin.value='tar -xzf "'+n+'"');o.submit()}break;case"mgzp":if(c()){n=l,doManageZip(encodeURIComponent(curDir+n))}break;case"webv":if(c()){if(n=l,t.shiftKey){let e=prompt("URL:",n);if(!e)break;n=e}pop(ctxPrf+curDir.slice(curDir.search("/"))+n,screen.availHeight,.6*screen.availWidth)}break;case"gitr":c()&&(".git"==l?(a="?dir="+curDir,pop(fmx_appPath+"gitter.php"+a,screen.availHeight,1200)):alert("Please select a '.git' folder"));break;case"jxtr":if(c()){let e=(n=curDir+l).match(/([^\/\\]+)\.(\w+)$/);e&&"xml"==e[2]?postAction(null,a={act:"jxtr",fref:n,dir:curDir},e=>{e&&alert(e)}):alert("Must be an XML file")}break;case"sql3":if(!s||c()){a="?dir="+curDir,s&&(a="?dbf="+curDir+l),pop(fmx_appPath+"pla/phpliteadmin.php"+a,screen.availHeight,.8*screen.availWidth)}break;case"fmxi":postAction("fmxi",{},e=>{let n,o=e.updt?e.updt.split("|"):null;n=o?{...aMsgDlg,buttons:{update:{text:"Update Now"}}}:aMsgDlg,rjOpenDlg(t,n,{fattrs:{"span.aMsg":e.msg+"<br>&nbsp;","div.titl span":"FMX - Hosted File Manager"},cb:e=>{"update"==e&&confirm("It is a good idea to backup first. Do you want to continue with the update?")&&postAndRefresh(a={act:"updt",nver:o[1]})}})},!0);break;case"cmcs":postAction("CLIC",{},e=>{let a=_rj.id("footerPop"),n=rjHtmlElement("div",{id:"util-view"},e);n.addEventListener("click",e=>{document.getElementById("cmdlin").value=e.target.closest("[data-cmd]").dataset.cmd,a.removeChild(n)}),n.style.left=t.pageX+8+"px",a.appendChild(n),n.style.top=8-n.clientHeight+"px"});break;case"mnu":break;default:alert("?"+e+"?")}}function doRenameFile(e,t){rjOpenDlg(t,fRenDlg,{fattrs:{'input[name="oldnm"]|value':e,'input[name="nunam"]|value':e},cb:(e,t)=>{if("rename"!=e)return;let a=t.get("nunam").trim();if(!a)return alert("Please enter a valid name"),!1;postAndRefresh({act:"fren",fref:curDir+t.get("oldnm"),nunm:curDir+a})}})}function doViewFile(e){pop(fmx_appPath+"filwin.php?fref="+e,675,900)}function doEditFile(e,t){let a="",n=e.split(".").pop();["htm","html"].indexOf(n)>=0&&confirm("Use WYSIWYG html editor? Has the side effect of reformatting an original file with some possible loss of data. Would be best to first edit a copy of an original.")&&(a="h"),editWindow=t?window.open(fmx_appPath+a+"filedwin.php?t=1&fref="+e,"_blank"):pop(fmx_appPath+a+"filedwin.php?fref="+e,screen.availHeight,screen.availWidth)}function doEditImage(e){popPost(fmx_appPath+"imgedtwin.php",{fref:e},"imgedt",screen.availHeight,Math.min(1200,screen.availWidth))}function doManageZip(e){let t=fmx_appPath+"arcview.php?fref="+e;editWindow=pop(t,.75*screen.availHeight,.5*screen.availWidth)}function doFileAction(e,t,a){a&&(a.preventDefault(),a.stopPropagation());let n,o=t.closest("[data-fref]").dataset.fref,r=encodeURIComponent(curDir+o);switch(e){case"finf":n={act:e,fref:r},postAction(null,n,e=>rjOpenDlg(a,aMsgDlg,{fattrs:{"span.aMsg":e+"<br>&nbsp;","div.titl span":"File info for: "+o}}));break;case"fvue":doViewFile(r);break;case"fedt":doEditFile(r,!!a&&a.altKey);break;case"iedt":doEditImage(r);break;default:alert("?"+e+"?")}}function fils2up(){if(""===document.cliterm.cmdlin.value)return alert("Please enter a command."),!1;{let e=document.cliterm.cmdlin.value;return e.indexOf("$$")>0&&(document.cliterm.cmdlin.value=e.replace("$$",makeFileList(sessionStorage.fmx_mrkd,!1))),document.cliterm.submit(),!0}}function selectionAction(e){let t="";"undefined"!==window.getSelection?t=window.getSelection():"undefined"!==document.selection&&"Text"==document.selection.type&&(t=document.selection.createRange().text);let a=curDir+t;e?doEditFile(a):doViewFile(a)}function display_cmmStorage(e){if(!e)return void alert("[ empty ]");let t="",a=e.split("\0");for(let e in a){let n=decodeURIComponent(a[e]).split("&");for(let e=0;e<n.length;e++)e>0&&(t+="    "),t+=n[e]+"\n"}alert(t)}function show_mcount(e,t){let a=document.getElementById(e),n=a.innerHTML.split("(");if(!t)return void(a.innerHTML=n[0]);let o=t.split("\0"),r=0;for(let e in o){let t=decodeURIComponent(o[e]).split("&");for(let e=0;e<t.length;e++)e&&r++}a.innerHTML=n[0]+"("+r+")"}function bump_mcount(e,t){let a=document.getElementById(e),n=a.innerHTML.split("(");if(t<0)a.innerHTML=n[0];else if(n[1]){let e=n[1],o=e.substr(0,e.length-1);a.innerHTML=n[0]+"("+(+o+t)+")"}else a.innerHTML=n[0]+"("+t+")"}function cm_del(e,t){let a=e.closest("[data-fref]").dataset.fref;if(confirm("Are you sure you want to delete this "+(t?"folder and contents":"file")+": "+a+" ?")){postAndRefresh({act:"delf",dir:curDir,"files[]":a})}}function cm_dld(e,t){postAction(null,{act:"dnld",dir:curDir,"files[]":e.closest("[data-fref]").dataset.fref+(t?"/":"")},e=>{e?downloadFile(e.fpth,"Y"==e.rad,!1):alert("download not available")},!0)}function cm_dup(e){postAndRefresh({act:"dupl",fref:curDir+e.closest("[data-fref]").dataset.fref})}function cm_ren(e){doRenameFile(e.closest("[data-fref]").dataset.fref,event)}function cm_zip(e,t){let a=e.closest("[data-fref]").dataset.fref,n=document.forms.cliterm,o="zip ";t&&(o+="-r ");let r=a.replace(/\s/g,"_");n.cmdlin.value=o+r+'.zip "'+a+'"',n.submit()}function cm_slnk(){if(!sessionStorage.fmx_mrkd)return void alert("Mark something to link first");let e=sessionStorage.fmx_mrkd.split("\0");if(1!=e.length)return void alert("Can SymLink to only one location at a time");let t=e[0].split("&"),a=t[0].split("="),n=a[1].replace(/%2F/g,"/");a=t[1].split("=");let o=a[1].replace(/%2F/g,"/"),r=prompt("Link to marked:","");null!==r&&postAndRefresh({act:"slnk",fref:n+"/"+o,tref:curDir,alnk:r})}const ctxmenus={filCtx:{1:{text:"Edit",act:e=>doFileAction("fedt",e,null)},2:{text:"Delete",act:e=>cm_del(e,!1)},3:{text:"Download",act:e=>cm_dld(e,!1)},4:{text:"Duplicate",act:e=>cm_dup(e,!1)},5:{text:"Rename",act:e=>cm_ren(e)},6:{text:"Zip",act:e=>cm_zip(e,!1)}},fldCtx:{2:{text:"Delete",act:e=>cm_del(e,!0)},3:{text:"Download",act:e=>cm_dld(e,!0)},4:{text:"Duplicate",act:e=>cm_dup(e,!0)},5:{text:"Rename",act:e=>cm_ren(e)},6:{text:"Zip",act:e=>cm_zip(e,!0)}},uplCtx:{1:{text:"H5win",act:()=>upldAction.H5w()},2:{text:"H5ovr",act:()=>upldAction.H5o()},3:{text:"L4win",act:()=>upldAction.L4w()},4:{text:"L4ovr",act:()=>upldAction.L4o()}},cppCtx:{1:{text:"Clear",act:()=>{sessionStorage.removeItem("fmx_cppa"),bump_mcount("cppaMenu",-1)}},2:{text:"Display",act:()=>display_cmmStorage(sessionStorage.fmx_cppa)}},delCtx:{1:{text:"Truly Delete",act:()=>doMenuAction("delf",null)},2:{text:"Empty Trash",act:()=>doMenuAction("mpty",null)},3:{text:"View Trash",act:()=>doMenuAction("tvew",null)}},mrkCtx:{1:{text:"Clear",act:()=>{sessionStorage.removeItem("fmx_mrkd"),bump_mcount("markMenu",-1)}},2:{text:"Display",act:()=>display_cmmStorage(sessionStorage.fmx_mrkd)},3:{text:"SymLink",act:()=>cm_slnk()}},mvtCtx:{1:{text:"Clear",act:()=>{sessionStorage.removeItem("fmx_mvto"),bump_mcount("mvtoMenu",-1)}},2:{text:"Display",act:()=>display_cmmStorage(sessionStorage.fmx_mvto)}}},fmx_init=()=>{try{sessionStorage.fmx_ok=1}catch(e){alert("Your browser 'sessionStorage' is not functioning. (private browsing?) Not all functions of FMX will work successfully.")}sessionStorage.fmx_curD=curDir,_rj.ae("fmnu","click",e=>{e.preventDefault(),doMenuAction(e.target.closest("[data-mnu]").dataset.mnu,e)}),_rj.ae("footerPopContent","click",e=>{e.preventDefault(),doMenuAction(e.target.closest("[data-mnu]").dataset.mnu,e)}),_rj.ae("ftbl","click",e=>{let t=e.target.closest("[data-act]")?.dataset.act;t&&(e.preventDefault(),doFileAction(t,e.target,e))}),document.querySelectorAll("nav>ul>.drpm").forEach(e=>{e.addEventListener("click",e=>{"drpm"==e.target.parentElement.className&&e.stopPropagation(),e.target.closest(".drpm").style.display="block";let t=e.target.parentElement.querySelector("ul");t&&(t.style.display="block",fmx_ui.ddm=t)})}),document.querySelectorAll("nnav .drpm ul").forEach(e=>{e.addEventListener("mouseout",e=>{let t=e.target;"UL"==t.nodeName&&(t.style.display="nonee")},!0)});let e=document.querySelectorAll(".fsel"),t=null;e.forEach(a=>{a.addEventListener("click",function(n){if(n.shiftKey&&t){let n=Array.from(e).indexOf(t),o=Array.from(e).indexOf(a);n>o&&([n,o]=[o,n]);for(let t=n;t<=o;t++)e[t].checked=this.checked}if(t=this,this.checked){let t=0;e.forEach(e=>{e.checked||(t=1)}),0===t&&(_rj.id("checkAll").checked=!0)}else _rj.id("checkAll").checked=!1})}),show_mcount("cppaMenu",sessionStorage.fmx_cppa),show_mcount("markMenu",sessionStorage.fmx_mrkd),show_mcount("mvtoMenu",sessionStorage.fmx_mvto),window.filesDrop=new FileDropper(_rj.id("filsform"),e=>upldAction.H5o(()=>fupQadd2(e)))};document.addEventListener("DOMContentLoaded",()=>fmx_init());class FileDropper{constructor(e,t){e.addEventListener("dragover",this,!1),e.addEventListener("drop",this,!1),e.addEventListener("dragenter",this,!1),e.addEventListener("dragleave",this,!1),this.cb=t}handleEvent(e){switch(e.preventDefault(),e.type){case"drop":let t=e.dataTransfer.files;this.cb(t);break;case"dragenter":e.target.classList.add("upld-body");break;case"dragleave":e.target.classList.remove("upld-body")}}}