'use strict';function refreshFilst(){window.location=window.location.href.split("#")[0]}function refreshFilstO(a){var c=window.location.href.split("#")[0].split("?");window.location=c[1]?c[0]+"?"+c[1].split("&")[0]+"&O="+a:c[0]+"?O="+a}const form2string=a=>{a=new FormData(document.forms[a]);return(new URLSearchParams(a)).toString()},toFormData=a=>{const c=new FormData;Object.keys(a).forEach(b=>{"object"!==typeof a[b]?c.append(b,a[b]):c.append(b,JSON.stringify(a[b]))});return c};
function postAction(a,c={},b=()=>{},d=!1){"object"===typeof c?c instanceof FormData||(c=toFormData(c)):"string"===typeof c&&(c=new URLSearchParams(c));a&&c.set("act",a);fetch(fmx_AJ,{method:"POST",body:c}).then(e=>{if(!e.ok)throw Error("Network response was not OK");return d?e.json():e.text()}).then(e=>b(e)).catch(e=>alert(e))}function postAndRefresh(a,c=()=>{}){postAction(null,a,b=>{c();b?alert(b):refreshFilst()})}
function postFormAndRefresh(a){let c=new FormData(document.forms.filst);c.set("act",a);postAndRefresh(c)}
var aMsgDlg={title:"Message:",cselect:"#aMsgDlog",hasX:!0},aSchDlg={cselect:"#aSchDlog",hasX:!0,buttons:{search:{text:"Search"}}},fRenDlg={id:4,title:"Rename...",cselect:"#fRenDlog",modal:!0,hasX:!0,buttons:{rename:{text:"Rename"}}},fNamDlg={cselect:"#fNamDlog",hasX:!0,buttons:{create:{text:"Create"}}},upldAction={H5w:()=>popUp(fmx_appPath+"filupld5.php"),H5o:a=>RJ_DlogMgr.fetchDlog(fmx_appPath+"filupld5.php?o=1",{title:"Upload files ...",ready:()=>{H5uSetup();a&&a()}}),L4w:()=>popUp(fmx_appPath+
"filupld.php"),L4o:()=>RJ_DlogMgr.fetchDlog(fmx_appPath+"filupld.php?o=1",{title:"Upload files ..."})};function downloadFile(a,c,b){a=fmx_appPath+"fildnld.php?fle="+encodeURI(a)+(c?"&tcdl=1&rad=Y":"")+(b?"&asf="+b:"");c=document.createElement("iframe");c.src=a;c.style.display="none";document.body.appendChild(c)}
function makeFileList(a,c){c=c?"<br />":" ";var b="",d;a=a.split("\x00");var e,f=encodeURIComponent(curDir).length;for(d in a){var l=a[d].split("&");var h="";for(e in l){var g=l[e].split("=");0===1*e?h=g[1].substr(f):b+=h+"%2F"+g[1]+c}}return b.replace(/%2F/g,"/")}function doesSupportAjaxUploadWithProgress(){var a;if(a="undefined"!==typeof window.FileList)a=new XMLHttpRequest,a=!!(a&&"upload"in a&&"onprogress"in a.upload);return a}
function pop(a,c,b){b>screen.availWidth&&(b=screen.availWidth);return window.open(a,"","toolbar=no,status=no,location=no,menubar=no,resizable=0,scrollbars=1,width="+b+",height="+c+",left="+(screen.width-b)/2+",top="+(screen.height-c)/2)}
function popPost(a,c,b,d,e){e>screen.availWidth&&(e=screen.availWidth);let f="",l;for(l in c)f+='<input type="hidden" name="'+l+'" value="'+c[l]+'" />';a=rjHtmlElement("form",{action:a,method:"post",target:b},f);document.body.appendChild(a);window.open("",b,"toolbar=no,status=no,location=no,menubar=no,resizable=0,scrollbars=1,width="+e+",height="+d+",left="+(screen.width-e)/2+",top="+(screen.height-d)/2).focus();a.submit()}function popUp(a){pop(a,240,416)}
function doMenuAction(a,c){var b=document.querySelectorAll(".fsel:checked"),d=b[0]?.parentElement.parentElement.dataset.fref,e=b.length;var f=()=>{if(e)if(1<e)alert("Please select only one item.");else return!0;else alert("An item needs to be selected");return!1};var l=()=>{if(e)return!0;alert("Some items need to be selected");return!1};switch(a){case "cppa":e?(sessionStorage.fmx_cppa=form2string("filst"),show_mcount("cppaMenu",sessionStorage.fmx_cppa)):sessionStorage.fmx_cppa&&postAndRefresh("act=cppa&todr="+
encodeURIComponent(curDir)+"&"+sessionStorage.fmx_cppa);break;case "trsh":l()&&(1==e||confirm("You have multiple files selected. Are you sure you want to trash ALL the selected files?"))&&postFormAndRefresh("trsh");break;case "mpty":postAndRefresh("act=mpty");break;case "delf":l()&&(1==e||confirm("You have multiple files selected. Are you sure you want to delete ALL the selected files?"))&&postFormAndRefresh("delf");break;case "tvew":window.location="?dir=tmp/Trash";break;case "dnld":if(l()){let g=
document.querySelector("div.dnldprg");g.style.display="inline";var h=new FormData(document.forms.filst);h.set("act","dnld");postAction(null,h,k=>{g.style.display="none";k?downloadFile(k.fpth,"Y"==k.rad,!1):alert("download not available")},!0)}break;case "dupl":f()&&(h={act:"dupl",fref:curDir+d},postAndRefresh(h));break;case "mark":h=void 0===sessionStorage.fmx_mrkd?"":sessionStorage.fmx_mrkd+"\x00";e&&(sessionStorage.fmx_mrkd=h+form2string("filst"),bump_mcount("markMenu",e));break;case "mmiz":f()&&
RJ_DlogMgr.fetchDlog("jsmini.php?f="+encodeURIComponent(d),{title:"Minimize javascript file..."});break;case "mvto":e?(sessionStorage.fmx_mvto=form2string("filst"),show_mcount("mvtoMenu",sessionStorage.fmx_mvto)):sessionStorage.fmx_mvto?(h=sessionStorage.fmx_mvto,sessionStorage.removeItem("fmx_mvto"),postAndRefresh("act=mvto&todr="+encodeURIComponent(curDir)+"&"+h)):alert("Nothing previously selected to move");break;case "nfle":case "nfld":fNamDlg.title="nfle"==a?"New File":"New Folder";rjOpenDlg(c,
fNamDlg,{fattrs:{'input[name="act"]|value':a},cb:(g,k)=>{if("create"==g){g=k.get("fref").trim();if(!g)return alert("Please enter a valid name"),!1;k={act:k.get("act"),fref:curDir+g};postAndRefresh(k)}}});break;case "refr":refreshFilst();break;case "rnam":f()&&doRenameFile(d,c);break;case "srhf":case "srhc":b=sessionStorage.fmx_strmf;"srhc"==a?(b=sessionStorage.fmx_strmc,aSchDlg.title="Search files for content..."):aSchDlg.title="Search for file named like...";rjOpenDlg(c,aSchDlg,{fattrs:{'input[name="cmd"]|value':a,
'input[name="sterm"]|value':b},cb:(g,k)=>{if("search"==g){g=k.get("sterm").trim();if(!g)return alert("Please enter a valid search term"),!1;k=k.get("cmd");var m=document.forms.cliterm;"srhf"===k?(sessionStorage.fmx_strmf=g,m.cmdlin.value="find ./ -name "+g+" -ls"):(sessionStorage.fmx_strmc=g,m.cmdlin.value="grep -R -I "+g+" *");m.submit()}}});break;case "turl":f()&&RJ_DlogMgr.fetchDlog(fmx_appPath+"filcurlm.php?t=1",{title:"Send file to URL ..."});break;case "furl":RJ_DlogMgr.fetchDlog(fmx_appPath+
"filcurlm.php",{title:"Get file from URL ..."});break;case "mdya":pop(fmx_appPath+"media.php?sd=/"+sessionStorage.fmx_curD,screen.availHeight,1200);break;case "upld":doesSupportAjaxUploadWithProgress()?upload_winpop?upldAction.H5w():upldAction.H5o():upload_winpop?upldAction.L4w():upldAction.L4o();break;case "uzip":case "zip":case "tarz":case "utrz":if(f()){f=document.forms.cliterm;if("zip"==a){if(a="zip ",b[0].parentElement.nextElementSibling.classList.contains("foldCtxt")&&(a+="-r "),b=d.replace(/\s/g,
"_"),f.cmdlin.value=a+b+'.zip "'+d+'"',c.shiftKey)if(a=prompt("COMMAND:",f.cmdlin.value+' -x "*/sv_*" -x "*/.git*"'))f.cmdlin.value=a;else break}else"uzip"==a?f.cmdlin.value='unzip "'+d+'"':"tarz"==a?(b=d.replace(/\s/g,"_"),f.cmdlin.value="tar -czf "+b+'.tgz "'+d+'"'):"utrz"==a&&(f.cmdlin.value='tar -xzf "'+d+'"');f.submit()}break;case "mgzp":f()&&(a=encodeURIComponent(curDir+d),doManageZip(a));break;case "webv":if(f()){if(c.shiftKey)if(a=prompt("URL:",d))d=a;else break;a=ctxPrf+curDir.slice(curDir.search("/"));
pop(a+d,screen.availHeight,.6*screen.availWidth)}break;case "gitr":f()&&(".git"==d?(h="?dir="+curDir,pop(fmx_appPath+"gitter.php"+h,screen.availHeight,1200)):alert("Please select a '.git' folder"));break;case "jxtr":f()&&(d=curDir+d,(a=d.match(/([^\/\\]+)\.(\w+)$/))&&"xml"==a[2]?(h={act:"jxtr",fref:d,dir:curDir},postAction(null,h,g=>{g&&alert(g)})):alert("Must be an XML file"));break;case "sql3":if(!e||f())h="?dir="+curDir,e&&(h="?dbf="+curDir+d),pop(fmx_appPath+"pla/phpliteadmin.php"+h,screen.availHeight,
.8*screen.availWidth);break;case "fmxi":postAction("fmxi",{},g=>{let k=g.updt?g.updt.split("|"):null;rjOpenDlg(c,k?{...aMsgDlg,buttons:{update:{text:"Update Now"}}}:aMsgDlg,{fattrs:{"span.aMsg":g.msg+"<br>&nbsp;","div.titl span":"FMX - Hosted File Manager"},cb:m=>{"update"==m&&confirm("It is a good idea to backup first. Do you want to continue with the update?")&&(h={act:"updt",nver:k[1]},postAndRefresh(h))}})},!0);break;case "cmcs":postAction("CLIC",{},g=>{let k=_rj.id("footerPop"),m=rjHtmlElement("div",
{id:"util-view"},g);m.addEventListener("click",n=>{document.getElementById("cmdlin").value=n.target.closest("[data-cmd]").dataset.cmd;k.removeChild(m)});m.style.left=c.pageX+8+"px";k.appendChild(m);m.style.top=-m.clientHeight+8+"px"});break;case "mnu":break;default:alert("?"+a+"?")}}var editWindow;
function doRenameFile(a,c){rjOpenDlg(c,fRenDlg,{fattrs:{'input[name="oldnm"]|value':a,'input[name="nunam"]|value':a},cb:(b,d)=>{if("rename"==b){b=d.get("nunam").trim();if(!b)return alert("Please enter a valid name"),!1;d={act:"fren",fref:curDir+d.get("oldnm"),nunm:curDir+b};postAndRefresh(d)}}})}function doViewFile(a){pop(fmx_appPath+"filwin.php?fref="+a,675,900)}
function doEditFile(a,c){let b="",d=a.split(".").pop();0<=["htm","html"].indexOf(d)&&confirm("Use WYSIWYG html editor? Has the side effect of reformatting an original file with some possible loss of data. Would be best to first edit a copy of an original.")&&(b="h");editWindow=c?window.open(fmx_appPath+b+"filedwin.php?t=1&fref="+a,"_blank"):pop(fmx_appPath+b+"filedwin.php?fref="+a,screen.availHeight,screen.availWidth)}
function doEditImage(a){popPost(fmx_appPath+"imgedtwin.php",{fref:a},"imgedt",screen.availHeight,Math.min(1200,screen.availWidth))}function doManageZip(a){editWindow=pop(fmx_appPath+"arcview.php?fref="+a,.75*screen.availHeight,.5*screen.availWidth)}
function doFileAction(a,c,b){b&&(b.preventDefault(),b.stopPropagation());let d=c.closest("[data-fref]").dataset.fref;c=encodeURIComponent(curDir+d);switch(a){case "finf":a={act:a,fref:c};postAction(null,a,e=>rjOpenDlg(b,aMsgDlg,{fattrs:{"span.aMsg":e+"<br>&nbsp;","div.titl span":"File info for: "+d}}));break;case "fvue":doViewFile(c);break;case "fedt":doEditFile(c,b?b.altKey:!1);break;case "iedt":doEditImage(c);break;default:alert("?"+a+"?")}}
function fils2up(){if(""===document.cliterm.cmdlin.value)return alert("Please enter a command."),!1;var a=document.cliterm.cmdlin.value;0<a.indexOf("$$")&&(document.cliterm.cmdlin.value=a.replace("$$",makeFileList(sessionStorage.fmx_mrkd,!1)));document.cliterm.submit();return!0}
function selectionAction(a){var c="";"undefined"!==window.getSelection?c=window.getSelection():"undefined"!==document.selection&&"Text"==document.selection.type&&(c=document.selection.createRange().text);c=curDir+c;a?doEditFile(c):doViewFile(c)}function display_cmmStorage(a){if(a){var c="";a=a.split("\x00");for(var b in a)for(var d=decodeURIComponent(a[b]).split("&"),e=0;e<d.length;e++)0<e&&(c+="    "),c+=d[e]+"\n";alert(c)}else alert("[ empty ]")}
function show_mcount(a,c){a=document.getElementById(a);let b=a.innerHTML.split("(");if(c){c=c.split("\x00");var d=0;for(let e in c){let f=decodeURIComponent(c[e]).split("&");for(let l=0;l<f.length;l++)l&&d++}a.innerHTML=b[0]+"("+d+")"}else a.innerHTML=b[0]}function bump_mcount(a,c){a=document.getElementById(a);let b=a.innerHTML.split("(");if(0>c)a.innerHTML=b[0];else if(b[1]){var d=b[1];d=d.substr(0,d.length-1);a.innerHTML=b[0]+"("+(+d+c)+")"}else a.innerHTML=b[0]+"("+c+")"}
function cm_del(a,c){a=a.closest("[data-fref]").dataset.fref;confirm("Are you sure you want to delete this "+(c?"folder and contents":"file")+": "+a+" ?")&&postAndRefresh({act:"delf",dir:curDir,"files[]":a})}function cm_dld(a,c){a={act:"dnld",dir:curDir,"files[]":a.closest("[data-fref]").dataset.fref+(c?"/":"")};postAction(null,a,b=>{b?downloadFile(b.fpth,"Y"==b.rad,!1):alert("download not available")},!0)}
function cm_dup(a){a={act:"dupl",fref:curDir+a.closest("[data-fref]").dataset.fref};postAndRefresh(a)}function cm_ren(a){a=a.closest("[data-fref]").dataset.fref;doRenameFile(a,event)}function cm_zip(a,c){a=a.closest("[data-fref]").dataset.fref;var b=document.forms.cliterm,d="zip ";c&&(d+="-r ");c=a.replace(/\s/g,"_");b.cmdlin.value=d+c+'.zip "'+a+'"';b.submit()}
function cm_slnk(){if(sessionStorage.fmx_mrkd){var a=sessionStorage.fmx_mrkd.split("\x00");if(1!=a.length)alert("Can SymLink to only one location at a time");else{var c=a[0].split("&"),b=c[0].split("=");a=b[1].replace(/%2F/g,"/");b=c[1].split("=");c=b[1].replace(/%2F/g,"/");b=prompt("Link to marked:","");null!==b&&postAndRefresh({act:"slnk",fref:a+"/"+c,tref:curDir,alnk:b})}}else alert("Mark something to link first")}
const ctxmenus={filCtx:{1:{text:"Edit",act:a=>doFileAction("fedt",a,null)},2:{text:"Delete",act:a=>cm_del(a,!1)},3:{text:"Download",act:a=>cm_dld(a,!1)},4:{text:"Duplicate",act:a=>cm_dup(a,!1)},5:{text:"Rename",act:a=>cm_ren(a)},6:{text:"Zip",act:a=>cm_zip(a,!1)}},fldCtx:{2:{text:"Delete",act:a=>cm_del(a,!0)},3:{text:"Download",act:a=>cm_dld(a,!0)},4:{text:"Duplicate",act:a=>cm_dup(a,!0)},5:{text:"Rename",act:a=>cm_ren(a)},6:{text:"Zip",act:a=>cm_zip(a,!0)}},uplCtx:{1:{text:"H5win",act:()=>upldAction.H5w()},
2:{text:"H5ovr",act:()=>upldAction.H5o()},3:{text:"L4win",act:()=>upldAction.L4w()},4:{text:"L4ovr",act:()=>upldAction.L4o()}},cppCtx:{1:{text:"Clear",act:()=>{sessionStorage.removeItem("fmx_cppa");bump_mcount("cppaMenu",-1)}},2:{text:"Display",act:()=>display_cmmStorage(sessionStorage.fmx_cppa)}},delCtx:{1:{text:"Truly Delete",act:()=>doMenuAction("delf",null)},2:{text:"Empty Trash",act:()=>doMenuAction("mpty",null)},3:{text:"View Trash",act:()=>doMenuAction("tvew",null)}},mrkCtx:{1:{text:"Clear",
act:()=>{sessionStorage.removeItem("fmx_mrkd");bump_mcount("markMenu",-1)}},2:{text:"Display",act:()=>display_cmmStorage(sessionStorage.fmx_mrkd)},3:{text:"SymLink",act:()=>cm_slnk()}},mvtCtx:{1:{text:"Clear",act:()=>{sessionStorage.removeItem("fmx_mvto");bump_mcount("mvtoMenu",-1)}},2:{text:"Display",act:()=>display_cmmStorage(sessionStorage.fmx_mvto)}}},fmx_init=()=>{try{sessionStorage.fmx_ok=1}catch(b){alert("Your browser 'sessionStorage' is not functioning. (private browsing?) Not all functions of FMX will work successfully.")}sessionStorage.fmx_curD=
curDir;_rj.ae("fmnu","click",b=>{b.preventDefault();doMenuAction(b.target.closest("[data-mnu]").dataset.mnu,b)});_rj.ae("footerPopContent","click",b=>{b.preventDefault();doMenuAction(b.target.closest("[data-mnu]").dataset.mnu,b)});_rj.ae("ftbl","click",b=>{let d=b.target.closest("[data-act]")?.dataset.act;d&&(b.preventDefault(),doFileAction(d,b.target,b))});document.querySelectorAll("nav>ul>.drpm").forEach(b=>{b.addEventListener("click",d=>{"drpm"==d.target.parentElement.className&&d.stopPropagation();
d.target.closest(".drpm").style.display="block";if(d=d.target.parentElement.querySelector("ul"))d.style.display="block",fmx_ui.ddm=d})});document.querySelectorAll("nnav .drpm ul").forEach(b=>{b.addEventListener("mouseout",d=>{d=d.target;"UL"==d.nodeName&&(d.style.display="nonee")},!0)});let a=document.querySelectorAll(".fsel"),c=null;a.forEach(b=>{b.addEventListener("click",function(d){if(d.shiftKey&&c){var e=Array.from(a).indexOf(c);d=Array.from(a).indexOf(b);for(e>d&&([e,d]=[d,e]);e<=d;e++)a[e].checked=
this.checked}c=this;if(this.checked){let f=0;a.forEach(l=>{l.checked||(f=1)});0===f&&(_rj.id("checkAll").checked=!0)}else _rj.id("checkAll").checked=!1})});show_mcount("cppaMenu",sessionStorage.fmx_cppa);show_mcount("markMenu",sessionStorage.fmx_mrkd);show_mcount("mvtoMenu",sessionStorage.fmx_mvto)};document.addEventListener("DOMContentLoaded",()=>fmx_init());